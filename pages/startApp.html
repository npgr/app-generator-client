<html>
<head>
 <title>Start App</title>
 <style>
		html, div {
			background-color: rgb(30, 30, 30);
			color: rgb(240,240,240);
			font-family: sans-serif;
			font-size: 15px;
		}
		[red] {
			color: red;
		}
		[orange] {
			color: orange;
		}
		[green] {
			color: green;
		}
		[yellow] {
			color: yellow;
		}
	</style>
</head>
<body onunload="endApp()"> <!-- onload="newContent();"-->
	
	<div yellow>> Starting Application 
		<strong id="app"></strong>
		<br>
	</div>
	
	<div id="list"></div>

	<script>
		cont = 0
		function append_html(txt)
		{
			var node = document.createElement("P");               
			var textnode = document.createTextNode(txt);       
			node.appendChild(textnode); 
			document.getElementById("list").appendChild(node);
			node.scrollIntoView()
		}
		function append_text(txt)
		{
			var textnode = document.createTextNode(txt);      
			document.getElementById("list").appendChild(textnode);
			//node.scrollIntoView()
		}
		function endApp()
		{
			child.kill()
			//append_html('Ending App')
			//child.stdin.setEncoding('utf-8');
			//child.stdin.write('\x03')
		}
		function start_app(app, port)
		{
			append_html('Executing: .../Apps/'+app+'/node app ()')
			
			var spawn = require('child_process').spawn;
			child = spawn('node',['Apps/'+app+'/app'])
			
			//var exec = require('child_process').exec;
			//child = exec('nodemon Apps/'+app+'/app')
			
			//child = spawn('npm',['start'], {cwd: 'Apps/'+app} );  Does not Work

			child.stdout.on('data', function(data) {
				append_html(data.toString())
				
				if (first_time) {
					first_time = false
					setTimeout(function() { open_browser(port) } , 3500);
					//setTimeout(function() { endApp() } , 10000);	
				}
				/*cont ++
				if (cont % 200 == 0)
				  append_text('* ')	*/
			})

			child.stderr.on('data', function (data) {
				append_html('Message: '+ data.toString())
				
			});
	
			child.on('close', function (code, signal) {
				//console.log('child process terminated due to receipt of signal ' + signal);	
				if (code == 0)
				{
					//copy_node_modules()
					//append_html("Process End with code: "+code)
					append_html('Application Created Succefully on Path ...Generator/Client/Apps/'+app)
					append_html('For start Server, run node app in above Path')
					append_html('===')
					append_html('Enjoy your New Application. Find Help on path ...')
					append_html('Close this Window for Continue')	
				}
				else 
					append_html("Process End with code: "+code)
			});
		}
		function open_browser(port) {
			//var file = require('fs').readFileSync('./config.json', 'utf8')
			//var url_to_open = JSON.parse(file).url
		
			var child2 = require('child_process')
			var url_to_open = 'http://localhost:'+port;
			var command = 'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'

			child2.spawn(command, ['-new-tab', url_to_open]);
			/*console.log("Opening Browser")
			var exec = require('child_process').exec

			exec('chrome http://localhost:3000' , function(err) {
				if(err){ 
					console.log("error: "+err)
				}
				else{ console.log("success open")
				}
			})*/
		}
		//Not Used
		function copy_node_modules() {
			cont = 0
			append_html('Intalling Node Modules')
			var spawn = require('child_process').spawn;
			var child2 = spawn('cp',['-R', '-v', '../server/node_modules/*', 'apps/app01/node_modules/']);
			//var execFile = require('child_process').execFile;
			//var child2 = execFile('npm',['install'], {cwd: 'apps/app01'} );
	
			child2.stdout.on('data', function(data) {
				//append_html(data.toString())
				cont ++
				if (cont % 30 == 0)
				  append_text('* ')	
			})
	
			child2.stderr.on('data', function (data) {
				append_html('stderr: '+ data.toString())
			});
	
			child2.on('close', function (code, signal) {
				if (code == 0 || code == 1) 
				{
					append_html('Application Created Sunccefully on Path Apps/app01')
					append_html('For start Server, run node app')
				}
				else 
					append_html('Process End with code: '+ code)
			})
		}
		//Main Logic
		//console.log('URL: ', window.location.href )
		var par = window.location.search.substring(1)
		var regex = /[=&]/
		var vars = par.split(regex);
		
		var app = vars[1]
		var port = vars[3]

		document.getElementById("app").innerHTML = app
		first_time = true
		start_app(app, port)
	</script>
</body>
</html>